<?xml version="1.0" encoding="UTF-8"?> 
<!DOCTYPE mapper PUBLIC
		   "-//mybatis.org//DTD Mapper 3.0//EN" 
		   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="users_mapper">
	
	<!-- 회원가입 -->
	<insert id="insertUser" parameterType="Users">
		insert into t_users(id, user_id, pw, email, name)
		values (seq_users.NEXTVAL, #{userId}, #{pw}, #{email}, #{name})
	</insert>
	
	<!-- 아이디 중복 확인 -->
	<select id="countByUserId" parameterType="string" resultType="int">
		select count(*) from t_users where user_id = #{userId}
	</select>
	
	<!-- 이메일 인증 -->
	<insert id="insertEmailCode" parameterType="EmailCode">
		merge into t_email_verification t
		using(select #{email} AS email, #{code} AS code from dual) s
		on (t.email = s.email)
		when matched then
			update set t.code = s.code, t.created_at= SYSDATE
		when not matched then
			insert (email, code, created_at) values (s.email, s.code, SYSDATE)
	</insert>
	
	<!-- 인증번호 확인 -->
	<select id="getCodeByEmail" parameterType="string" resultType="string">
		select code from t_email_verification where email = #{email}
	</select>
	
</mapper>